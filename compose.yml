services:
  debridmoviemapper:
    image: ghcr.io/phrontizo/debridmoviemapper:latest
    container_name: debridmoviemapper
    restart: unless-stopped
    user: "65534:65534"
    ports:
      - "8080:8080"
    environment:
      - RD_API_TOKEN=your_real_debrid_token
      - TMDB_API_KEY=your_tmdb_api_key
      - SCAN_INTERVAL_SECS=60
    volumes:
      - ./metadata.db:/metadata.db

  rclone:
    image: rclone/rclone:latest
    container_name: rclone
    restart: unless-stopped
    user: "1000:1000"
    depends_on:
      - debridmoviemapper
    devices:
      - /dev/fuse
    cap_add:
      - SYS_ADMIN
    security_opt:
      - apparmor:unconfined
    volumes:
      - ./rclone.conf:/config/rclone/rclone.conf
      - jellyfin-media:/mnt/debrid:rshared
    command: >
      mount debrid: /mnt/debrid
      --vfs-cache-mode writes
      --vfs-cache-max-size 1G
      --allow-other
      --allow-non-empty
      --dir-cache-time 10s
      --poll-interval 15s

  jellyfin:
    image: jellyfin/jellyfin:latest
    container_name: jellyfin
    restart: unless-stopped
    user: "1000:1000"
    depends_on:
      - rclone
    ports:
      - "8096:8096"
    environment:
      - JELLYFIN_PublishedServerUrl=http://localhost:8096
    volumes:
      - jellyfin-config:/config
      - jellyfin-cache:/cache
      - jellyfin-media:/media:ro
    devices:
      - /dev/dri:/dev/dri  # Optional: for hardware transcoding

volumes:
  jellyfin-media: {}
  jellyfin-cache: {}
  jellyfin-config: {}
