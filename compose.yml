services:
  debridmoviemapper:
    image: ghcr.io/phrontizo/debridmoviemapper:latest
    container_name: debridmoviemapper
    restart: unless-stopped
    user: "65534:65534"
    ports:
      - "8082:8080"
    environment:
      - RD_API_TOKEN=your_real_debrid_token
      - TMDB_API_KEY=your_tmdb_api_key
      # Jellyfin notifications (all three required to enable)
      - JELLYFIN_URL=http://jellyfin:8096
      - JELLYFIN_API_KEY=your_jellyfin_api_key
      - JELLYFIN_RCLONE_MOUNT_PATH=/media
    volumes:
      - ./metadata.db:/metadata.db

  rclone:
    image: rclone/rclone:latest
    container_name: rclone
    restart: unless-stopped
    user: "65534:65534"
    depends_on:
      - debridmoviemapper
    devices:
      - /dev/fuse
    cap_add:
      - SYS_ADMIN
    security_opt:
      - apparmor:unconfined
    volumes:
      - ./rclone.conf:/config/rclone/rclone.conf
      - ./rclone:/data:rshared
    tmpfs:
      - /cache:mode=700,uid=65534,gid=65534
    environment:
      - TZ=Europe/London
    command: >
      mount debrid: /data
      --vfs-cache-mode writes
      --vfs-cache-max-size 1G
      --allow-other
      --allow-non-empty
      --dir-cache-time 10s
      --poll-interval 15s
      --cache-dir /cache

  jellyfin:
    image: jellyfin/jellyfin:latest
    container_name: jellyfin
    restart: unless-stopped
    user: "65534:65534"
    depends_on:
      - rclone
    ports:
      - "8096:8096"
    volumes:
      - jellyfin-config:/config
      - jellyfin-cache:/cache
      - ./rclone:/media:ro
    devices:
      - /dev/dri:/dev/dri  # Optional: for hardware transcoding

volumes:
  jellyfin-cache: {}
  jellyfin-config: {}
